import*as e from"https://cdn.jsdelivr.net/npm/three@0.112.1/build/three.module.js";import{GUI as ye}from"https://cdn.jsdelivr.net/npm/three@0.112.1/examples/jsm/libs/dat.gui.module.js";import{PointerLockControls as xe}from"https://cdn.jsdelivr.net/npm/three@0.112.1/examples/jsm/controls/PointerLockControls.js";import{WEBGL as be}from"https://cdn.jsdelivr.net/npm/three@0.112.1/examples/jsm/WebGL.js";import ke from"https://cdn.jsdelivr.net/npm/three@0.112.1/examples/jsm/libs/stats.module.js";import{Sky as ve}from"https://cdn.jsdelivr.net/npm/three@0.112.1/examples/jsm/objects/Sky.js";import{Water as Ce}from"https://cdn.jsdelivr.net/npm/three@0.112.1/examples/jsm/objects/Water.js";import"https://cdn.jsdelivr.net/npm/simplex-noise@2.4.0/simplex-noise.js";import Se from"https://cdn.jsdelivr.net/gh/mikechambers/es6-perlin-module/perlin.js";import{GLTFLoader as Me}from"https://unpkg.com/three@0.119.1/examples/jsm/loaders/GLTFLoader.js";(function(){const h=document.createElement("link").relList;if(h&&h.supports&&h.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const l of t)if(l.type==="childList")for(const d of l.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function o(t){const l={};return t.integrity&&(l.integrity=t.integrity),t.referrerPolicy&&(l.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?l.credentials="include":t.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(t){if(t.ep)return;t.ep=!0;const l=o(t);fetch(t.href,l)}})();const Pe=function(){return{FPSControls:class{constructor(s){this._cells=s.cells,this._Init(s)}_Init(s){this._radius=2,this._enabled=!1,this._move={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1},this._standing=!0,this._velocity=new e.Vector3(0,0,0),this._decceleration=new e.Vector3(-10,-10,-10),this._acceleration=new e.Vector3(250,100,250),this._SetupPointerLock(),this._controls=new xe(s.camera,document.body),s.scene.add(this._controls.getObject()),document.addEventListener("keydown",h=>this._onKeyDown(h),!1),document.addEventListener("keyup",h=>this._onKeyUp(h),!1)}_onKeyDown(s){switch(s.keyCode){case 38:case 87:this._move.forward=!0;break;case 37:case 65:this._move.left=!0;break;case 40:case 83:this._move.backward=!0;break;case 39:case 68:this._move.right=!0;break;case 33:this._move.up=!0;break;case 34:this._move.down=!0;break}}_onKeyUp(s){switch(s.keyCode){case 38:case 87:this._move.forward=!1;break;case 37:case 65:this._move.left=!1;break;case 40:case 83:this._move.backward=!1;break;case 39:case 68:this._move.right=!1;break;case 33:this._move.up=!1;break;case 34:this._move.down=!1;break}}_SetupPointerLock(){if("pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document){const h=n=>{document.pointerLockElement===document.body||document.mozPointerLockElement===document.body||document.webkitPointerLockElement===document.body?(this._enabled=!0,this._controls.enabled=!0):this._controls.enabled=!1},o=n=>{console.log(n)};document.addEventListener("pointerlockchange",h,!1),document.addEventListener("webkitpointerlockchange",h,!1),document.addEventListener("mozpointerlockchange",h,!1),document.addEventListener("pointerlockerror",o,!1),document.addEventListener("mozpointerlockerror",o,!1),document.addEventListener("webkitpointerlockerror",o,!1),document.getElementById("target").addEventListener("click",n=>{if(document.body.requestPointerLock=document.body.requestPointerLock||document.body.mozRequestPointerLock||document.body.webkitRequestPointerLock,/Firefox/i.test(navigator.userAgent)){const t=l=>{(document.fullscreenElement===document.body||document.mozFullscreenElement===document.body||document.mozFullScreenElement===document.body)&&(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),document.body.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),document.body.requestFullscreen=document.body.requestFullscreen||document.body.mozRequestFullscreen||document.body.mozRequestFullScreen||document.body.webkitRequestFullscreen,document.body.requestFullscreen()}else document.body.requestPointerLock()},!1)}}_FindIntersections(s,h){const o=new e.Sphere(h,this._radius);return s.filter(t=>o.intersectsBox(t))}Update(s){if(!this._enabled)return;const h=new e.Vector3(this._velocity.x*this._decceleration.x,this._velocity.y*this._decceleration.y,this._velocity.z*this._decceleration.z);h.multiplyScalar(s),this._velocity.add(h),this._move.forward&&(this._velocity.z-=this._acceleration.z*s),this._move.backward&&(this._velocity.z+=this._acceleration.z*s),this._move.left&&(this._velocity.x-=this._acceleration.x*s),this._move.right&&(this._velocity.x+=this._acceleration.x*s),this._move.up&&(this._velocity.y+=this._acceleration.y*s),this._move.down&&(this._velocity.y-=this._acceleration.y*s);const o=this._controls.getObject(),n=new e.Vector3;n.copy(o.position);const t=new e.Vector3(0,0,1);t.applyQuaternion(o.quaternion),t.y=0,t.normalize();const l=new e.Vector3(0,1,0),d=new e.Vector3(1,0,0);d.applyQuaternion(o.quaternion),d.normalize(),d.multiplyScalar(this._velocity.x*s),l.multiplyScalar(this._velocity.y*s),t.multiplyScalar(this._velocity.z*s),o.position.add(t),o.position.add(d),o.position.add(l),n.copy(o.position)}}}}(),Ge=function(){function s(n){const t=document.createElement("canvas");t.width=n.width,t.height=n.height;const l=t.getContext("2d");return l.drawImage(n,0,0),l.getImageData(0,0,n.width,n.height)}function h(n,t,l){const d=(t+n.width*l)*4,p=n.data;return{r:p[d],g:p[d+1],b:p[d+2],a:p[d+3]}}class o{constructor(t){}Initialize(){if(!be.isWebGL2Available())return!1;this._threejs=new e.WebGLRenderer({antialias:!0}),this._threejs.setPixelRatio(window.devicePixelRatio),this._threejs.setSize(window.innerWidth,window.innerHeight),document.getElementById("target").appendChild(this._threejs.domElement),this._stats=new ke,window.addEventListener("resize",()=>{this._OnWindowResize()},!1);const l=60,d=1920/1080,p=1,_=25e3;return this._camera=new e.PerspectiveCamera(l,d,p,_),this._camera.position.set(75,20,0),this._scene=new e.Scene,this._scene.background=new e.Color(11184810),this._CreateLights(),!0}_CreateLights(){let t=new e.DirectionalLight(8421504,1,100);t.position.set(-100,100,-100),t.target.position.set(0,0,0),t.castShadow=!1,this._scene.add(t),t=new e.DirectionalLight(4210752,1.5,100),t.position.set(100,100,-100),t.target.position.set(0,0,0),t.castShadow=!1,this._scene.add(t)}_OnWindowResize(){this._camera.aspect=window.innerWidth/window.innerHeight,this._camera.updateProjectionMatrix(),this._threejs.setSize(window.innerWidth,window.innerHeight)}get Scene(){return this._scene}get Camera(){return this._camera}Render(t){this._threejs.render(this._scene,this._camera),this._stats.update()}}return{Graphics:o,GetPixel:h,GetImageData:s}}(),ze=function(){return{Game:class{constructor(){this._Initialize()}_Initialize(){if(this._graphics=new Ge.Graphics(this),!this._graphics.Initialize()){this._DisplayError("WebGL2 is not available.");return}this._previousRAF=null,this._minFrameTime=1/10,this._entities={},this._OnInitialize(),this._RAF()}_DisplayError(s){const h=document.getElementById("error");h.innerText=s}_RAF(){requestAnimationFrame(s=>{this._previousRAF===null&&(this._previousRAF=s),this._Render(s-this._previousRAF),this._previousRAF=s})}_StepEntities(s){for(let h in this._entities)this._entities[h].Update(s)}_Render(s){const h=Math.min(s*.001,this._minFrameTime);this._OnStep(h),this._StepEntities(h),this._graphics.Render(h),this._RAF()}}}}(),Le=function(){class s{constructor(o){this._params=o,this._Init(o)}_Init(o){const n=new e.PlaneBufferGeometry(1e4,1e4,100,100);this._water=new Ce(n,{textureWidth:2048,textureHeight:2048,waterNormals:new e.TextureLoader().load("../public/Ice.png",function(_){_.wrapS=_.wrapT=e.RepeatWrapping}),alpha:.5,sunDirection:new e.Vector3(1,0,0),sunColor:16768643,waterColor:13955577,distortionScale:0,fog:void 0}),this._water.rotation.x=-Math.PI/2,this._water.position.y=4,this._sky=new ve,this._sky.scale.setScalar(1e4),this._group=new e.Group,this._group.add(this._water),this._group.add(this._sky),o.scene.add(this._group),o.guiParams.sky={turbidity:10,rayleigh:2,mieCoefficient:.005,mieDirectionalG:.8,luminance:1},o.guiParams.sun={inclination:.31,azimuth:.25};const t=()=>{for(let _ in o.guiParams.sky)this._sky.material.uniforms[_].value=o.guiParams.sky[_];for(let _ in o.guiParams.general)this._sky.material.uniforms[_].value=o.guiParams.general[_]},l=()=>{var _=Math.PI*(o.guiParams.sun.inclination-.5),x=2*Math.PI*(o.guiParams.sun.azimuth-.5);const w=new e.Vector3;w.x=Math.cos(x),w.y=Math.sin(x)*Math.sin(_),w.z=Math.sin(x)*Math.cos(_),this._sky.material.uniforms.sunPosition.value.copy(w),this._water.material.uniforms.sunDirection.value.copy(w.normalize())},d=o.gui.addFolder("Sky");d.add(o.guiParams.sky,"turbidity",.1,30).onChange(t),d.add(o.guiParams.sky,"rayleigh",.1,4).onChange(t),d.add(o.guiParams.sky,"mieCoefficient",1e-4,.1).onChange(t),d.add(o.guiParams.sky,"mieDirectionalG",0,1).onChange(t),d.add(o.guiParams.sky,"luminance",0,2).onChange(t);const p=o.gui.addFolder("Sun");p.add(o.guiParams.sun,"inclination",0,1).onChange(l),p.add(o.guiParams.sun,"azimuth",0,1).onChange(l),t(),l()}Update(o){this._water.material.uniforms.time.value+=o,this._group.position.x=this._params.camera.position.x,this._group.position.z=this._params.camera.position.z}}return{TerrainSky:s}}(),j=function(){return{rand_range:function(s,h){return Math.random()*(h-s)+s},rand_normalish:function(){return(Math.random()+Math.random()+Math.random()+Math.random())/4*2-1},rand_int:function(s,h){return Math.round(Math.random()*(h-s)+s)},lerp:function(s,h,o){return s*(o-h)+h},smoothstep:function(s,h,o){return s=s*s*(3-2*s),s*(o-h)+h},smootherstep:function(s,h,o){return s=s*s*s*(s*(s*6-15)+10),s*(o-h)+h},clamp:function(s,h,o){return Math.min(Math.max(s,h),o)},sat:function(s){return Math.min(Math.max(s,0),1)}}}(),J=function(){class s{constructor(){}noise2D(t,l){return Se(t,l)*2-1}}class h{constructor(){this._values={}}_Rand(t,l){const d=t+"."+l;return d in this._values||(this._values[d]=Math.random()*2-1),this._values[d]}noise2D(t,l){const d=Math.floor(t),p=Math.floor(l),_=d+1,x=p+1,w=t-d,k=l-p,i=this._Rand(d,p),r=this._Rand(_,p),a=this._Rand(d,x),u=this._Rand(_,x),f=j.lerp(w,i,r),m=j.lerp(w,a,u);return j.lerp(k,f,m)}}class o{constructor(t){this._params=t,this._Init()}_Init(){this._noise={simplex:new SimplexNoise(this._params.seed),perlin:new s,rand:new h}}Get(t,l){const d=t/this._params.scale,p=l/this._params.scale,_=this._noise[this._params.noiseType],x=2**-this._params.persistence;let w=1,k=1,i=0,r=0;for(let a=0;a<this._params.octaves;a++){const u=_.noise2D(d*k,p*k)*.5+.5;r+=u*w,i+=w,w*=x,k*=this._params.lacunarity}return r/=i,Math.pow(r,this._params.exponentiation)*this._params.height}}return{Noise:o}}(),Fe=function(){class h{constructor(n){const t=new e.Box2(n.min,n.max);this._root={bounds:t,children:[],center:t.getCenter(new e.Vector2),size:t.getSize(new e.Vector2)}}GetChildren(){const n=[];return this._GetChildren(this._root,n),n}_GetChildren(n,t){if(n.children.length==0){t.push(n);return}for(let l of n.children)this._GetChildren(l,t)}Insert(n){this._Insert(this._root,new e.Vector2(n.x,n.z))}_Insert(n,t){if(this._DistanceToChild(n,t)<n.size.x&&n.size.x>500){n.children=this._CreateChildren(n);for(let d of n.children)this._Insert(d,t)}}_DistanceToChild(n,t){return n.center.distanceTo(t)}_CreateChildren(n){const t=n.bounds.getCenter(new e.Vector2),l=new e.Box2(n.bounds.min,t),d=new e.Box2(new e.Vector2(t.x,n.bounds.min.y),new e.Vector2(n.bounds.max.x,t.y)),p=new e.Box2(new e.Vector2(n.bounds.min.x,t.y),new e.Vector2(t.x,n.bounds.max.y)),_=new e.Box2(t,n.bounds.max);return[l,d,p,_].map(w=>({bounds:w,children:[],center:w.getCenter(new e.Vector2),size:w.getSize(new e.Vector2)}))}}return{QuadTree:h}}(),Y=function(){class s{constructor(n){this._points=[],this._lerp=n}AddPoint(n,t){this._points.push([n,t])}Get(n){let t=0;for(let _=0;_<this._points.length&&!(this._points[_][0]>=n);_++)t=_;const l=Math.max(0,t-1),d=Math.min(this._points.length-1,t+1),p=Math.min(this._points.length-1,t+2);return t==d?this._points[t][1]:this._lerp((n-this._points[t][0])/(this._points[d][0]-this._points[t][0]),this._points[l][1],this._points[t][1],this._points[d][1],this._points[p][1])}}class h{constructor(n){this._points=[],this._lerp=n}AddPoint(n,t){this._points.push([n,t])}Get(n){let t=0;for(let d=0;d<this._points.length&&!(this._points[d][0]>=n);d++)t=d;const l=Math.min(this._points.length-1,t+1);return t==l?this._points[t][1]:this._lerp((n-this._points[t][0])/(this._points[l][0]-this._points[t][0]),this._points[t][1],this._points[l][1])}}return{CubicHermiteSpline:s,LinearSpline:h}}(),H=function(){return{DictIntersection:function(s,h){const o={};for(let n in h)n in s&&(o[n]=s[n]);return o},DictDifference:function(s,h){const o={...s};for(let n in h)delete o[n];return o}}}();new e.Scene;const Re=function(){class s{constructor(i,r,a,u){this._position=r.clone(),this._radius=[a,u],this._generator=i}Get(i,r){const a=this._position.distanceTo(new e.Vector2(i,r));let u=1-j.sat((a-this._radius[0])/(this._radius[1]-this._radius[0]));return u=u*u*(3-2*u),[this._generator.Get(i,r),u]}}new e.Color(8421504);const h=new e.Color(14275986);new e.Color(14275986);const o=new e.Color(16777215);new e.Color(5218063),new e.Color(2856462);const n=new e.Color(2736384);new e.Color(8454016),new e.Color(16744576),new e.Color(0);const t=500,l=10,d=64;class p{constructor(i){const r=(a,u,f)=>u.clone().lerpHSL(f,a);this._colourSpline=[new Y.LinearSpline(r),new Y.LinearSpline(r)],this._colourSpline[0].AddPoint(0,new e.Color(12035709)),this._colourSpline[0].AddPoint(.5,new e.Color(15851964)),this._colourSpline[0].AddPoint(1,o),this._colourSpline[1].AddPoint(0,n),this._colourSpline[1].AddPoint(.5,new e.Color(13559196)),this._colourSpline[1].AddPoint(1,o),this._params=i}Get(i,r,a){this._params.biomeGenerator.Get(i,a);const u=r/100;return u<.05?h:(this._colourSpline[0].Get(u),this._colourSpline[1].Get(u),o)}}class _{constructor(i){this._params=i,this._Init(i),this.trees=[],this.scene=i.scene,console.log("this.scene")}Destroy(){this._params.group.remove(this._plane)}Hide(){this._plane.visible=!1}Show(){this._plane.visible=!0}_Init(i){console.log("chunk params: ",this._params),new e.TextureLoader().load("./Snow_seamless.jpg");const a=new e.Vector3(i.width,0,i.width);this._plane=new e.Mesh(new e.PlaneGeometry(a.x,a.z,i.resolution,i.resolution),new e.MeshStandardMaterial({color:16777215})),this._plane.castShadow=!1,this._plane.receiveShadow=!0,this._plane.rotation.x=-Math.PI/2,this._params.group.add(this._plane)}_GenerateHeight(i){const r=this._params.offset,a=[];let u=0,f=0;for(let m of this._params.heightGenerators)a.push(m.Get(i.x+r.x,-i.y+r.y)),u+=a[a.length-1][1];if(u>0)for(let m of a)f+=m[0]*m[1]/u;return f}*_Rebuild(){const r=[],a=this._params.offset;let u=0,f=[];for(let c of this._plane.geometry.vertices)c.z=this._GenerateHeight(c),f.push(c.z),r.push(this._params.colourGenerator.Get(c.x+a.x,c.z,c.y+a.y)),u++,u>2e3&&(u=0,yield);let m=Math.max(...f.filter(c=>!isNaN(c)));new Me;for(let c of this._plane.geometry.vertices)if(c.z==m){const b=new e.MeshBasicMaterial({color:16756141}),v=new e.MeshBasicMaterial({color:16766629}),g=new e.MeshBasicMaterial({color:16646070}),C=new e.MeshBasicMaterial({color:13303743}),M=new e.MeshBasicMaterial({color:10221823}),K=new e.MeshBasicMaterial({color:10536191}),$=new e.MeshBasicMaterial({color:12432127}),S=new e.MeshBasicMaterial({color:16777215}),ee=new e.MeshBasicMaterial({color:12887172}),Q=new e.MeshBasicMaterial({color:16738489}),Z=new e.MeshBasicMaterial({color:11895659}),W=new e.CubeTextureLoader().load(["../public/Flower_texture.png","../public/Flower_texture.png","../public/Flower_texture.png","../public/Flower_texture.png","../public/Flower_texture.png","../public/Flower_texture.png"]),X=new e.BoxGeometry(25,300,25),te=new e.BoxGeometry(35,300,10),ie=new e.BoxGeometry(10,300,35),N=new e.Mesh(X,ee);N.position.set(c.x,0,c.y);const q=new e.Mesh(te,Z);q.position.set(c.x,0,c.y);const O=new e.Mesh(ie,Z);O.position.set(c.x,0,c.y),N.castShadow=!0,N.receiveShadow=!0,q.castShadow=!0,q.receiveShadow=!0,O.castShadow=!0,O.receiveShadow=!0,this.scene.add(N),this.trees.push(N),this.scene.add(q),this.trees.push(q),this.scene.add(O),this.trees.push(O);const se=new e.BoxGeometry(210,40,210),ne=new e.BoxGeometry(200,10,200),oe=new e.BoxGeometry(180,37,180),re=new e.BoxGeometry(180,10,180),ae=new e.BoxGeometry(160,34,160),ce=new e.BoxGeometry(160,10,160),he=new e.BoxGeometry(140,31,140),le=new e.BoxGeometry(140,10,140),ue=new e.BoxGeometry(120,28,120),de=new e.BoxGeometry(120,10,120),_e=new e.BoxGeometry(100,25,100),me=new e.BoxGeometry(100,10,100),pe=new e.BoxGeometry(80,22,80),fe=new e.BoxGeometry(80,10,80),we=new e.BoxGeometry(175,50,175),ge=new e.BoxGeometry(350,30,350);W.wrapS=W.wrapT=e.MirroredRepeatWrapping,W.offset.set(.5,.5),new e.Mesh(X,new e.MeshStandardMaterial({map:W}));const A=new e.Mesh(se,b),U=new e.Mesh(ne,S),P=new e.Mesh(oe,v),G=new e.Mesh(re,S),z=new e.Mesh(ae,g),L=new e.Mesh(ce,S),F=new e.Mesh(he,C),R=new e.Mesh(le,S),E=new e.Mesh(ue,M),I=new e.Mesh(de,S),B=new e.Mesh(_e,K),T=new e.Mesh(me,S),D=new e.Mesh(pe,$),V=new e.Mesh(fe,S);new e.Mesh(we,Q),new e.Mesh(ge,Q);const y=.8971;A.position.set(c.x,160,c.y),A.castShadow=!0,A.receiveShadow=!0,this.scene.add(A),this.trees.push(A),U.position.set(c.x,190,c.y),U.castShadow=!0,U.receiveShadow=!0,this.scene.add(U),this.trees.push(U),P.position.set(c.x,200,c.y),P.rotation.y=y,P.castShadow=!0,P.receiveShadow=!0,this.scene.add(P),this.trees.push(P),G.position.set(c.x,237,c.y),G.rotation.y=y,G.castShadow=!0,G.receiveShadow=!0,this.scene.add(G),this.trees.push(G),z.position.set(c.x,247,c.y),z.rotation.y=2*y,z.castShadow=!0,z.receiveShadow=!0,this.scene.add(z),this.trees.push(z),L.position.set(c.x,281,c.y),L.rotation.y=2*y,L.castShadow=!0,L.receiveShadow=!0,this.scene.add(L),this.trees.push(L),F.position.set(c.x,291,c.y),F.rotation.y=3*y,F.castShadow=!0,F.receiveShadow=!0,this.scene.add(F),this.trees.push(F),R.position.set(c.x,322,c.y),R.rotation.y=3*y,R.castShadow=!0,R.receiveShadow=!0,this.scene.add(R),this.trees.push(R),E.position.set(c.x,332,c.y),E.rotation.y=4*y,E.castShadow=!0,E.receiveShadow=!0,this.scene.add(E),this.trees.push(E),I.position.set(c.x,360,c.y),I.rotation.y=4*y,I.castShadow=!0,I.receiveShadow=!0,this.scene.add(I),this.trees.push(I),B.position.set(c.x,370,c.y),B.rotation.y=5*y,B.castShadow=!0,B.receiveShadow=!0,this.scene.add(B),this.trees.push(B),T.position.set(c.x,395,c.y),T.rotation.y=5*y,T.castShadow=!0,T.receiveShadow=!0,this.scene.add(T),this.trees.push(T),D.position.set(c.x,405,c.y),D.rotation.y=6*y,D.castShadow=!0,D.receiveShadow=!0,this.scene.add(D),this.trees.push(D),V.position.set(c.x,427,c.y),V.rotation.y=6*y,V.castShadow=!0,V.receiveShadow=!0,this.scene.add(V),this.trees.push(V)}for(let c of this._plane.geometry.faces){const b=[c.a,c.b,c.c],v=[];for(let g of b)v.push(r[g]);c.vertexColors=v,u++,u>2e3&&(u=0,yield)}yield,this._plane.geometry.elementsNeedUpdate=!0,this._plane.geometry.verticesNeedUpdate=!0,this._plane.geometry.computeVertexNormals(),this._plane.position.set(a.x,0,a.y)}}class x{constructor(i){this._pool={},this._params=i,this._Reset()}AllocateChunk(i){const r=i.width;r in this._pool||(this._pool[r]=[]);let a=null;return this._pool[r].length>0?(a=this._pool[r].pop(),a._params=i):a=new _(i),a.Hide(),this._queued.push(a),a}_RecycleChunks(i){for(let r of i)r.chunk._params.width in this._pool||(this._pool[r.chunk._params.width]=[]),r.chunk.Hide(),this._pool[r.chunk._params.width].push(r.chunk)}_Reset(){this._active=null,this._queued=[],this._old=[],this._new=[]}get Busy(){return this._active}Update2(){for(let i of this._queued)i._Rebuild().next(),this._new.push(i);if(this._queued=[],!this._active&&!this._queued.length){this._RecycleChunks(this._old);for(let i of this._new)i.Show();this._Reset()}}Update(){if(this._active)this._active.next().done&&(this._active=null);else{const i=this._queued.pop();i&&(this._active=i._Rebuild(),this._new.push(i))}if(!this._active&&!this._queued.length){this._RecycleChunks(this._old);for(let i of this._new)i.Show();this._Reset()}}}class w{constructor(i){this._Init(i)}_Init(i){this._params=i,this._material=new e.MeshStandardMaterial({wireframe:!1,wireframeLinewidth:1,color:16777215,side:e.FrontSide,vertexColors:e.VertexColors}),console.log("params: ",i),this._builder=new x(i),this._InitNoise(i),this._InitBiomes(i),this._InitTerrain(i)}_InitNoise(i){i.guiParams.noise={octaves:6,persistence:.707,lacunarity:1.8,exponentiation:4.5,height:300,scale:1100,noiseType:"simplex",seed:1};const r=()=>{for(let f in this._chunks)this._chunks[f].chunk.Rebuild()},a=i.gui.addFolder("Terrain.Noise");a.add(i.guiParams.noise,"noiseType",["simplex","perlin","rand"]).onChange(r),a.add(i.guiParams.noise,"scale",32,4096).onChange(r),a.add(i.guiParams.noise,"octaves",1,20,1).onChange(r),a.add(i.guiParams.noise,"persistence",.25,1).onChange(r),a.add(i.guiParams.noise,"lacunarity",.01,4).onChange(r),a.add(i.guiParams.noise,"exponentiation",.1,10).onChange(r),a.add(i.guiParams.noise,"height",0,512).onChange(r),this._noise=new J.Noise(i.guiParams.noise),i.guiParams.heightmap={height:16},i.gui.addFolder("Terrain.Heightmap").add(i.guiParams.heightmap,"height",0,128).onChange(r)}_InitBiomes(i){i.guiParams.biomes={octaves:2,persistence:.5,lacunarity:2,exponentiation:3.9,scale:2048,noiseType:"simplex",seed:2,exponentiation:1,height:1};const r=()=>{for(let u in this._chunks)this._chunks[u].chunk.Rebuild()},a=i.gui.addFolder("Terrain.Biomes");a.add(i.guiParams.biomes,"scale",64,4096).onChange(r),a.add(i.guiParams.biomes,"octaves",1,20,1).onChange(r),a.add(i.guiParams.biomes,"persistence",.01,1).onChange(r),a.add(i.guiParams.biomes,"lacunarity",.01,4).onChange(r),a.add(i.guiParams.biomes,"exponentiation",.1,10).onChange(r),this._biomes=new J.Noise(i.guiParams.biomes)}_InitTerrain(i){i.guiParams.terrain={wireframe:!1},this._group=new e.Group,i.scene.add(this._group),i.gui.addFolder("Terrain").add(i.guiParams.terrain,"wireframe").onChange(()=>{for(let a in this._chunks)this._chunks[a].chunk._plane.material.wireframe=i.guiParams.terrain.wireframe}),this._chunks={},this._params=i}_CellIndex(i){const r=i.x+t*.5,a=i.z+t*.5,u=Math.floor(r/t),f=Math.floor(a/t);return[u,f]}_CreateTerrainChunk(i,r){const a={group:this._group,material:this._material,width:r,offset:new e.Vector3(i.x,i.y,0),resolution:d,biomeGenerator:this._biomes,colourGenerator:new p({biomeGenerator:this._biomes}),heightGenerators:[new s(this._noise,i,1e5,100001)],scene:this._params.scene};return this._builder.AllocateChunk(a)}Update(i){this._builder.Update(),this._builder.Busy||this._UpdateVisibleChunks_Quadtree()}_UpdateVisibleChunks_Quadtree(){function i(g){return g.position[0]+"/"+g.position[1]+" ["+g.dimensions[0]+"]"}const r=new Fe.QuadTree({min:new e.Vector2(-32e3,-32e3),max:new e.Vector2(32e3,32e3)});r.Insert(this._params.camera.position);const a=r.GetChildren();let u={};const f=new e.Vector2,m=new e.Vector2;for(let g of a){g.bounds.getCenter(f),g.bounds.getSize(m);const C={position:[f.x,f.y],bounds:g.bounds,dimensions:[m.x,m.y]},M=i(C);u[M]=C}const c=H.DictIntersection(this._chunks,u),b=H.DictDifference(u,this._chunks),v=Object.values(H.DictDifference(this._chunks,u));this._builder._old.push(...v),u=c;for(let g in b){const[C,M]=b[g].position,K=new e.Vector2(C,M);u[g]={position:[C,M],chunk:this._CreateTerrainChunk(K,b[g].dimensions[0])}}this._chunks=u}_UpdateVisibleChunks_FixedGrid(){function i(m,c){return m+"/"+c}const[r,a]=this._CellIndex(this._params.camera.position),u={};for(let m=-10;m<=l;m++)for(let c=-10;c<=l;c++){const b=i(m+r,c+a);u[b]={position:[m+r,c+a]}}const f=H.DictDifference(u,this._chunks);Object.values(H.DictDifference(this._chunks,u));for(let m in f){if(m in this._chunks)continue;const[c,b]=f[m].position,v=new e.Vector2(c*t,b*t);this._chunks[m]={position:[r,a],chunk:this._CreateTerrainChunk(v,t)}}}_UpdateVisibleChunks_Single(){function i(m,c){return m+"/"+c}const[r,a]=this._CellIndex(this._params.camera.position),u=i(r,a);if(u in this._chunks)return;const f=new e.Vector2(r*t,a*t);this._chunks[u]={position:[r,a],chunk:this._CreateTerrainChunk(f,t)}}}return{TerrainChunkManager:w}}();class Ee extends ze.Game{constructor(){super()}_OnInitialize(){this._CreateGUI(),this._userCamera=new e.Object3D,this._userCamera.position.set(475,75,900),this._entities._terrain=new Re.TerrainChunkManager({camera:this._userCamera,scene:this._graphics.Scene,gui:this._gui,guiParams:this._guiParams}),this._entities._sky=new Le.TerrainSky({camera:this._graphics.Camera,scene:this._graphics.Scene,gui:this._gui,guiParams:this._guiParams}),this._entities._controls=new Pe.FPSControls({scene:this._graphics.Scene,camera:this._userCamera}),this._graphics.Camera.position.copy(this._userCamera.position),this._LoadBackground()}_CreateGUI(){this._guiParams={general:{}},this._gui=new ye,this._gui.addFolder("General"),this._gui.close()}_LoadBackground(){this._graphics.Scene.background=new e.Color(0)}_OnStep(h){this._graphics._camera.position.copy(this._userCamera.position),this._graphics._camera.quaternion.copy(this._userCamera.quaternion)}}function Ie(){new Ee}Ie();
